---
title: "Sales_USDA_linear"
author: "Oliver Causey"
date: "9/4/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
devtools::load_all("../BPI/")
library(data.table)
library(corrplot)
library(ggplot2)
library(EnvStats)
library(MASS) #for boxcox
#plot predictors vs residuals. worry if there is a pattern
library(kableExtra)
library(MLmetrics)
set.seed(123)
```

```{r functions, echo=FALSE}


#' Remove commas in numeric column
#' @title rm_comma
#' @param x a character or a character vector
#' @example rm_comma("92,006")
rm_comma <- function(x){
  x <- as.numeric(gsub(",","", x))
  return(x)
}

################
################
################
#function to generate linear model results
#using the growing envelope technique.
get_linear_results <- function(model_data,
                               include_USDA_proj) {
  linear_results <- c()
for ( i in 1:(nrow(model_data)-1)) {
  dataset_temp <- as.data.frame(model_data[1:(i),])
  data <- as.data.frame(copy(dataset_temp))
  linear_temp <- lm(acres_corn_US ~ ., data = data)


  linear_results[i] <- predict(linear_temp, 
                               subset(model_data[i], 
                                      select = -acres_corn_US))

}
#get predictions, response
predictions <- unlist(linear_results)[1:(nrow(model_data)-1)]
response<- model_data$acres_corn_US[1:nrow(model_data)]



#calculate basic metrics and put into tabular form
mae  <- MAE(predictions, response)/1000000
mape <- MAPE(predictions, response)*100
rmse <- RMSE(predictions, response)/1000000

stats_table <- rbind(mae,mape,rmse)
row.names(stats_table) <- c("MAE (Million Acres)", 
                            "MAPE (%) ", 
                            "RMSE (Million Acres)")
stats_table
}


################
################
################
#function to generate linear model results
#using the moving window technique.

moving_window <- function(window_size,
                          model_data,
                          include_USDA_proj) {
  linear_results <- c()
for ( i in 1:(nrow(model_data)-1)) {
  dataset_temp <- as.data.frame(model_data[i:(i + window_size -1),])
  data <- as.data.frame(copy(dataset_temp))
  linear_temp <- lm(acres_corn_US ~ ., data = data)

  linear_results[i] <- predict(linear_temp, 
                               subset(model_data[i+window_size], 
                                      select = -acres_corn_US))

}


#get predictions and response
predictions <- unlist(linear_results)[1:(nrow(model_data)-window_size)]
response<- model_data$acres_corn_US[(window_size+1):nrow(model_data)]
results <- data.table()
#calculate basic metrics and put into tabular form
mae  <- MAE(predictions,  response)/1000000
mape <- MAPE(predictions, response)*100
rmse <- RMSE(predictions, response)/1000000

stats_table <- rbind(mae,mape,rmse)
row.names(stats_table) <- c("MAE (Million Acres)", 
                            "MAPE (%) ", 
                            "RMSE (Million Acres)")
stats_table
}


#################
#################
#################
#function to add noise for noise testing
moving_window_jitter <- function(window_size, noise) {
  linear_results <- c()
for ( i in 1:(nrow(model_data)-1)) {
  dataset_temp <- as.data.frame(model_data[i:(i + window_size -1),])
  data <- as.data.frame(copy(dataset_temp))
  linear_temp <- lm(jitter(acres_corn_US, noise) ~ ., data = data)

if (include_USDA_proj){linear_results[i] <- predict(linear_temp, 
                           model_data[i+window_size,1:2])}
  else{
linear_results[i] <- predict(linear_temp, 
                           model_data[i+window_size,1])
}
}

#get predications and response
predictions <- unlist(linear_results)[1:(nrow(model_data)-window_size)]
response<- model_data$acres_corn_US[(window_size+1):nrow(model_data)]

#calculate basic metrics
mae  <- MAE(predictions,  response)/1000000
mape <- MAPE(predictions, response)*100
rmse <- RMSE(predictions, response)/1000000

#put basic metrics into tabular format
stats_table <- rbind(mae,mape,rmse)
row.names(stats_table) <- c("MAE (Million Acres)", 
                            "MAPE (%) ", 
                            "RMSE (Million Acres)")
stats_table
}

```

```{r munge_data, echo = FALSE, message = FALSE}
############################
############################
############################
############################
munge_data <- function(data_file_path, 
                       number_of_months = 1, 
                       include_USDA_proj = F){
  
sales_data <- readxl::read_xlsx(data_file_path)
names(sales_data) <- sales_data[2,]

response_data <- as.data.table(read.csv("../data/raw/acreplanted_national_corn_nass_1926-2020.csv"))


#response data needs an easy to read name
response_data$acres_corn_US <- response_data$CORN...ACRES.PLANTED......b.VALUE..b.

#remove commas from acre data
response_data[, acres_corn_US:=rm_comma(acres_corn_US)]

#feature names are in second row of data
names(sales_data) <- sales_data[2,]

#remove non-data (empty rows and column name are the first two rows of data)
sales_data <- sales_data[3:nrow(sales_data),]


feature_dt <- as.data.table(sales_data)

response_dt <- as.data.table(response_data)


# remove "M" from year and month in sales data. 
feature_dt$year <- gsub( "M", "", as.character(feature_dt$`Market Year`) )
feature_dt$month <- gsub( "M", "", as.character(feature_dt$`MY Month Nbr`))


#assign the same data type to merging column
response_dt$year <- as.integer(response_dt$Year)
feature_dt$year <- as.integer(feature_dt$year)


#merge data
data_by_month <- merge(feature_dt,response_dt,by ="year")

national_sales <- data_by_month[`Dealer Account CY Brand Family` == "NATIONAL",]
#grab useful columns
columns_to_keep <- c("year",
                     "month",
                     "Order Quantity",
                     "acres_corn_US")


dataset <- national_sales[, ..columns_to_keep]



data_numeric <- dataset[,lapply(dataset, as.numeric)]

#grab only data from November and earlier
sales <- data_numeric[data_numeric$month <= number_of_months,]

#merge the regional and national brand data
summed_national_sales <-sales[, "total_order" :=sum(`Order Quantity`),
                                               by=.(year,acres_corn_US) ]


cols_to_keep <- c("total_order",  "acres_corn_US", "year")
orders_acres <- unique(summed_national_sales[,..cols_to_keep])

#merge usda projections with features 

#get USDA projection data
USDA <- read.csv("../data/raw/USDACornPlantingProjections.csv")
USDA$year <- as.numeric(substr(USDA$Year2, start = 6, stop = 10)) #Keeping the planting year of the 2 year range

#order by year so that we can use the each row containing the
# first instance of the year variable
USDA_ordered <- as.data.table(setorder(USDA, YearProjected2, year))

#if you are predicting on only september or sep/oct
#there are no in season projections from the usda.
#grab the correct row accordingly

if  (number_of_months < 3){
  
  ordered_projections <- USDA_ordered[year-YearProjected2 ==1]
}else{
  ordered_projections <- USDA_ordered[year-YearProjected2 ==0]
}

ordered_projections$projection <- as.numeric(ordered_projections$Value*1000000)
ordered_projections$year <- as.numeric(ordered_projections$year)

data_for_model <- merge(orders_acres, ordered_projections, by = "year")

if (include_USDA_proj){
columns_to_keep <- c("total_order",
                     "projection",
                     "acres_corn_US")
model_data <- data_for_model[ ,..columns_to_keep]
}else {
  columns_to_keep <- c("total_order",
                     "acres_corn_US")
  model_data <- data_for_model[,..columns_to_keep]
}

model_data <- na.omit(model_data)
return(model_data)
}
```

# Data
We have included Bayer National Brand corn seed sales data from 2006 - 2020.  We have also included USDA
in-season projection data for acres planted in the United states. For reasons described in the next 
section, the next iteration of the linear model will include y + 1 USDA projections for acres planted. 


# Base results
We need to document the results for the linear model. We have included the growing envelope and sliding 
window techniques.  The predictions are made with and without using USDA projections as predictors. Note,
the models that use September and October data only need to use y+1 projections from the USDA because
we are unable to getUSDA projections until early November. This has not yet been implemented. The models
are currently using in-season USDA projections.


# Growing envelope technique

```{r grow_dat_results, echo = FALSE}
growing_data_results <- function(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=1,
                         include_USDA_proj=F) {
model_data <- munge_data(data_file_path,
                        number_of_months, 
                       include_USDA_proj)
results <- data.table()
results <-get_linear_results( model_data, include_USDA_proj)
results <- data.frame(results)
row.names(results) <- c("MAE", "MAPE", "RMSE")
result <- (kable(results, digits = 2))
return(result)
}
```

```{r moving_dat_results, echo=FALSE}
moving_data_results <- function(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=1,
                         include_USDA_proj=F) {
  

model_data <- munge_data(data_file_path,
                        number_of_months, 
                       include_USDA_proj)
results <- data.table()
results$window_4 <-moving_window(5, model_data, include_USDA_proj)
results$window_5 <-moving_window(6, model_data, include_USDA_proj)
results$window_6 <-moving_window(7, model_data, include_USDA_proj)
results$window_7 <-moving_window(8, model_data, include_USDA_proj)
results$window_8 <-moving_window(9, model_data, include_USDA_proj)
results$window_9 <-moving_window(10, model_data,include_USDA_proj)
results <- data.frame(results)
row.names(results) <- c("MAE", "MAPE", "RMSE")
result <- (kable(results, digits = 2))
return(result)
}
```
## Growing Envelope September Sales without USDA projections
```{r gwsswoup, echo=FALSE}
growing_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=1,
                         include_USDA_proj=F)
```

## Growing Envelope September Sales with USDA projections
```{r gwsswup, echo=FALSE}
growing_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=1,
                         include_USDA_proj=T)
```
## Growing Envelope September/October Sales without USDA projections
```{r gwsoswoup, echo = FALSE}
growing_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=2,
                         include_USDA_proj=F)
```

## Growing Envelope September October Sales with USDA projections
```{r gwsoswup}
growing_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=2,
                         include_USDA_proj=T)
``` 

## Growing Envelope SepOctNov Sales without USDA projections
```{r gwsonswoup}
growing_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=3,
                         include_USDA_proj=F)
``` 
## Growing Envelope SepOctNov Sales with USDA projections
```{r gwsonswup}
growing_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=3,
                         include_USDA_proj=T)
``` 
# Moving Window Technique

## Moving Window September Sales without USDA projections
```{r mwsswoup, echo=FALSE}
moving_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=1,
                         include_USDA_proj=F)
```

## Moving Window September Sales with USDA projections
```{r mwsswup, echo=FALSE}
moving_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=1,
                         include_USDA_proj=T)
```

## Moving Window September/October Sales without USDA projections
```{r mwsoswoup, echo = FALSE}
moving_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=2,
                         include_USDA_proj=F)
```

## Moving Window September October Sales with USDA projections
```{r mwsoswup}
moving_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=2,
                         include_USDA_proj=T)
``` 

## Moving Window SepOctNov Sales without USDA projections
```{r mwsonswoup}
moving_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=3,
                         include_USDA_proj=F)
``` 
## Moving Window SepOctNov Sales with USDA projections
```{r mwsonswup}
moving_data_results(data_file_path="../data/raw/sales_2006-2020.xlsx", 
                         number_of_months=3,
                         include_USDA_proj=T)
``` 
